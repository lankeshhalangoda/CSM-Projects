<style>

/* Center content inside Emjot container */
.nps-bar {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Question text â€” match .emote-title exactly */
.nps-question {
  color: #000000;
  font-family: "Roboto", sans-serif;
  font-size: 15pt;
  font-weight: 600;
  text-align: left;
  max-width: 700px;
  margin-bottom: 30px;
  padding: 0;
}

/* Responsive font size */
@media (max-width: 768px) {
  .nps-question {
    font-size: 12pt !important;
  }
}

/* Hide default NPS buttons */
.evz-nps-position-0,
.evz-nps-position-1,
.evz-nps-position-2,
.evz-nps-position-3,
.evz-nps-position-4,
.evz-nps-position-5,
.evz-nps-position-6,
.evz-nps-position-7,
.evz-nps-position-8,
.evz-nps-position-9,
.evz-nps-position-10 {
  display: none !important;
}

/* Slider container */
.nps-slider-container {
  position: relative;
  width: 90%;
  max-width: 700px;
  text-align: center;
  z-index: 1000;
  margin-left: auto;
  margin-right: auto;
}

/* Slider styling */
.nps-slider {
  width: 100%;
  -webkit-appearance: none;
  appearance: none;
  height: 8px;
  border-radius: 10px;
  background: linear-gradient(90deg, #ff2942 0%, #ff7924 70%, #1ca757 100%);
  outline: none;
  cursor: pointer;
}

/* Numeric labels under slider */
.nps-slider-labels {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-top: 10px;
  color: #000;
}

/* Descriptive labels */
.nps-slider-container::before {
  content: "Less Likely";
  position: absolute;
  left: 0;
  bottom: -25px;
  font-size: 13px;
  color: #000;
}

.nps-slider-container::after {
  content: "More Likely";
  position: absolute;
  right: 0;
  bottom: -25px;
  font-size: 13px;
  color: #000;
}

/* Custom thumb with visible value */
.nps-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #000;
  border: 3px solid white;
  box-shadow: 0px 2px 4px rgba(0,0,0,0.3);
  cursor: pointer;
  position: relative;
  transition: transform 0.1s ease;
}

.nps-slider::-moz-range-thumb {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #000;
  border: 3px solid white;
  box-shadow: 0px 2px 4px rgba(0,0,0,0.3);
  cursor: pointer;
}

/* Number inside the thumb */
.thumb-value {
  position: absolute;
  color: white;
  font-size: 12px;
  font-weight: 600;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  user-select: none;
}

/* Responsive tweaks */
@media (max-width: 600px) {
  .nps-question {
    font-size: 18px;
    margin-bottom: 22px;
  }
  .nps-slider-container {
    width: 96%;
  }
  .nps-slider::-webkit-slider-thumb {
    width: 24px;
    height: 24px;
  }
  .thumb-value {
    font-size: 11px;
  }
}
</style>
</head>

<body>

  <p class="nps-question">
    How likely are you to recommend Abans to a friend or colleague?
  </p>

  <div class="nps-bar"></div>

<script>
(function NPSSlider() {
  const NPS_KEY = 'nps_default_key';   // swap to a per-question key if you have one
  let npsCommitted = false;            // tracks if we've committed a value this view
  let building = false;                 // prevent concurrent builds

  // Build (or re-build) the slider if needed
  function buildIfNeeded() {
    if (building) return;
    const bar = document.querySelector('.nps-bar');
    if (!bar) return;
    if (bar.querySelector('.nps-slider-container')) return; // already there

    building = true;

    // ---------- Build slider immediately ----------
    const sliderContainer = document.createElement('div');
    sliderContainer.classList.add('nps-slider-container');

    const slider = document.createElement('input');
    slider.type = 'range';
    slider.min = 0;
    slider.max = 10;
    slider.step = 1;

    // Start from session value (instant, no jump)
    const stored = sessionStorage.getItem(NPS_KEY);
    let initialVal = (stored !== null && !isNaN(+stored)) ? +stored : 5;

    // If Emojot already marked a selected button, prefer it
    const selectedNow = document.querySelector('[class*="evz-nps-position-"].clicked-nps-icon');
    if (selectedNow) {
      const m = selectedNow.className.match(/evz-nps-position-(\d+)/);
      if (m) initialVal = +m[1];
    }

    slider.value = initialVal;
    slider.classList.add('nps-slider');

    const thumbValue = document.createElement('div');
    thumbValue.classList.add('thumb-value');
    thumbValue.textContent = slider.value;
    sliderContainer.appendChild(thumbValue);

    const labels = document.createElement('div');
    labels.classList.add('nps-slider-labels');
    for (let i = 0; i <= 10; i++) {
      const s = document.createElement('span');
      s.textContent = i;
      labels.appendChild(s);
    }

    sliderContainer.appendChild(slider);
    sliderContainer.appendChild(labels);
    bar.appendChild(sliderContainer);

    // Position the number
    const updateThumb = () => {
      thumbValue.textContent = slider.value;
      const percent = (slider.value / 10) * 100;
      thumbValue.style.left = `calc(${percent}% - 14px)`;
    };
    updateThumb();

    let userInteracted = false;

    // While dragging
    slider.addEventListener('input', () => {
      userInteracted = true;
      npsCommitted = false;
      updateThumb();
    });

    // On release: save + trigger hidden button (auto-advance)
    slider.addEventListener('change', function () {
      const val = parseInt(this.value, 10);
      sessionStorage.setItem(NPS_KEY, String(val));
      const targetBtn = document.querySelector(`.evz-nps-position-${val}`);
      if (targetBtn) targetBtn.click();
      npsCommitted = true;
    });

    // Background sync (donâ€™t override if user already interacted)
    let tries = 0;
    (function syncSaved() {
      const selected = document.querySelector('[class*="evz-nps-position-"].clicked-nps-icon');
      if (selected) {
        const m = selected.className.match(/evz-nps-position-(\d+)/);
        if (m) {
          const saved = +m[1];
          if (!userInteracted && saved !== +slider.value) {
            slider.value = saved;
            updateThumb();
          }
          sessionStorage.setItem(NPS_KEY, String(saved));
          return; // stop syncing
        }
      }
      if (tries++ < 50) setTimeout(syncSaved, 200);
    })();

    building = false;
    // console.log('âš¡ NPS Slider (re)built');
  }

  // Initial attempt
  buildIfNeeded();

  // MutationObserver: rebuild when .nps-bar re-enters DOM (after Back/Submit)
  const mo = new MutationObserver(() => buildIfNeeded());
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // Also handle navigation events some SPAs use
  window.addEventListener('hashchange', buildIfNeeded);
  window.addEventListener('popstate', buildIfNeeded);
  window.addEventListener('pageshow', buildIfNeeded);

  // Ensure value is committed on Next even if user never moved slider (defaults to 5)
  document.addEventListener('click', function (e) {
    const nextBtn = e.target.closest('.btn-next');
    if (!nextBtn) return;

    const slider = document.querySelector('.nps-slider');
    if (!slider) return;

    if (!npsCommitted) {
      const val = parseInt(slider.value || '5', 10);
      sessionStorage.setItem(NPS_KEY, String(val));
      const targetBtn = document.querySelector(`.evz-nps-position-${val}`);
      if (targetBtn) targetBtn.click();
      npsCommitted = true;
      // console.log(`âœ… NPS committed on Next: ${val}`);
    }
  }, true);

  // Reset slider and stored value on Submit for a fresh start next time
  document.addEventListener('click', function (e) {
    const submitBtn = e.target.closest('.btn-submit');
    if (!submitBtn) return;

    sessionStorage.removeItem(NPS_KEY);
    npsCommitted = false;

    // If the slider is still visible, reset it visually
    const slider = document.querySelector('.nps-slider');
    const thumbValue = document.querySelector('.thumb-value');
    if (slider && thumbValue) {
      slider.value = 5;
      thumbValue.textContent = '5';
      const percent = (slider.value / 10) * 100;
      thumbValue.style.left = `calc(${percent}% - 14px)`;
      // console.log('ðŸ”„ NPS slider reset to 5 after submission');
    }

    // If the DOM is about to rebuild, the observer will re-build the slider anyway.
  }, true);
})();
</script>

</body>